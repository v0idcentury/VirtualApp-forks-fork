name: Compile VirtualApp (Android 14 | arm8 | xxhdpi)

on:
  push:
    branches: [ "master", "main" ]
  pull_request:
    branches: [ "master", "main" ]
  workflow_dispatch:

jobs:
  build-apk:
    name: Build Highly-Optimized VirtualApp APK
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Source Code
        uses: actions/checkout@v4

      - name: Setup JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      # Caching is disabled to bypass transient GitHub "400 Bad Request" outages 
      - name: Setup Fast Gradle Environment
        uses: gradle/actions/setup-gradle@v3
        with:
          gradle-version: wrapper
          cache-disabled: true 

      - name: üßπ Deep Sanitize Gradle Properties
        run: |
          # 1. Eradicate deprecated NDK flag causing Plugin initialization to crash
          sed -i '/android.useDeprecatedNdk/d' gradle.properties
          
          # 2. Fix Java 17 Metaspace crashes by purging MaxPermSize
          sed -i 's/MaxPermSize/MaxMetaspaceSize/g' gradle.properties
          
          # 3. Secure JVM limits to prevent ephemeral runner OOM memory locks
          sed -i 's/org.gradle.jvmargs=.*/org.gradle.jvmargs=-Xmx4096m -XX:MaxMetaspaceSize=1024m -XX:+HeapDumpOnOutOfMemoryError -Dfile.encoding=UTF-8/g' gradle.properties

      - name: üß¨ Eradicate Malformed AGP Code & Patch Codebase
        run: |
          # 1. ERADICATE the malformed nested 'android { defaultConfig { ndk { ... } } }' 
          # This specific copy-paste error in the repo causes the fatal 'No signature of method: android()' in AGP 7+
          perl -0777 -pi -e 's/android\s*\{\s*defaultConfig\s*\{\s*ndk\s*\{\s*abiFilters[^}]+\}\s*\}\s*\}/ndk { abiFilters "arm64-v8a" }/g' app/build.gradle
          
          # 2. ERADICATE deprecated 'processResources.manifestFile' logic that crashes AGP 7+
          # Using Perl to safely hollow out the closure without breaking bracket syntax
          perl -0777 -pi -e 's/output\.processResources\.doFirst\s*\{[^}]+\}//g' app/build.gradle
          
          # 3. Elevate compile & target SDK to 34 (Android 14) dynamically
          find . -name "build.gradle" -exec sed -i 's/compileSdkVersion [0-9]*/compileSdkVersion 34/g' {} +
          find . -name "build.gradle" -exec sed -i 's/targetSdkVersion [0-9]*/targetSdkVersion 34/g' {} +
          
          # 4. Remove hardcoded buildToolsVersion so Android SDK auto-resolves the proper 34.x.x toolchain
          find . -name "build.gradle" -exec sed -i '/buildToolsVersion/d' {} +

          # 5. Restrict ABI to arm64-v8a everywhere natively
          find . -name "build.gradle" -exec sed -i 's/"arm64-v8a", "x86_64"/"arm64-v8a"/g' {} +
          find . -name "build.gradle" -exec sed -i 's/\["armeabi-v7a"\]/\["arm64-v8a"\]/g' {} +

          # 6. Safely append the xxhdpi density splits into the App module context
          cat <<EOF >> app/build.gradle

          android {
              splits {
                  density {
                      enable true
                      reset()
                      include "xxhdpi"
                      universalApk false
                  }
              }
          }
          EOF

      - name: üîê Generate Native Release Keystore
        run: |
          keytool -genkey -v \
            -keystore release.jks \
            -keyalg RSA \
            -keysize 2048 \
            -validity 10000 \
            -alias virtualapp \
            -dname "CN=VirtualApp, OU=Dev, O=VirtualXposed, L=City, ST=State, C=US" \
            -storepass virtual123 \
            -keypass virtual123

          cat <<EOF > local.properties
          keystore.path=${GITHUB_WORKSPACE}/release.jks
          keystore.alias=virtualapp
          keystore.pwd=virtual123
          keystore.alias_pwd=virtual123
          EOF

      - name: üöÄ Assemble Release APK
        run: |
          chmod +x gradlew
          # `--no-daemon` disables memory locking on CI environments.
          ./gradlew assembleAospRelease --no-daemon --parallel --max-workers=$(nproc)

      - name: üì¶ Locate, Verify & Normalize APK Output
        run: |
          echo "Hunting for xxhdpi split..."
          APK_PATH=$(find app/build/outputs/apk -type f -name "*xxhdpi*.apk" | head -n 1)

          if [ -z "$APK_PATH" ]; then
            echo "‚ö†Ô∏è xxhdpi split not found. Grabbing Universal APK instead..."
            APK_PATH=$(find app/build/outputs/apk -type f -name "*.apk" | head -n 1)
          fi

          if [ -z "$APK_PATH" ]; then
            echo "‚ùå FATAL: APK build failed or output dir is entirely empty."
            exit 1
          fi

          echo "‚úÖ Built Successfully! Wrapping artifact from path: $APK_PATH"
          cp "$APK_PATH" VirtualApp-Android14-arm8-xxhdpi.apk

      - name: üì§ Upload Finished APK
        uses: actions/upload-artifact@v4
        with:
          name: VirtualApp-Android14-arm8-xxhdpi
          path: VirtualApp-Android14-arm8-xxhdpi.apk
          retention-days: 14
          if-no-files-found: error
