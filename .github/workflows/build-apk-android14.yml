name: Compile VirtualApp (Android 14 | arm8 | xxhdpi)

on:
  push:
    branches: [ "master", "main" ]
  pull_request:
    branches: [ "master", "main" ]
  workflow_dispatch:

jobs:
  build-apk:
    name: Build Highly-Optimized VirtualApp APK
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Source Code
        uses: actions/checkout@v4

      - name: Setup JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      # Caching is disabled to bypass transient GitHub "400 Bad Request" outages 
      # which were visible in your previous logs.
      - name: Setup Fast Gradle Environment
        uses: gradle/actions/setup-gradle@v3
        with:
          gradle-version: wrapper
          cache-disabled: true 

      - name: üßπ Purge Legacy JVM Arguments (CRITICAL FIX)
        run: |
          # The repository contains '-XX:MaxPermSize' in gradle.properties.
          # This crashes JDK 17+ instantly. We must replace it with 'MaxMetaspaceSize'.
          sed -i 's/-XX:MaxPermSize=1024m/-XX:MaxMetaspaceSize=1024m/g' gradle.properties
          sed -i 's/-XX:MaxPermSize=512m/-XX:MaxMetaspaceSize=512m/g' gradle.properties
          
          # Forcefully ensure org.gradle.jvmargs is safe
          sed -i 's/org.gradle.jvmargs=.*/org.gradle.jvmargs=-Xmx4096m -XX:MaxMetaspaceSize=1024m -XX:+HeapDumpOnOutOfMemoryError -Dfile.encoding=UTF-8/g' gradle.properties

      - name: üß¨ Apply Environment Modifications (Android 14, arm8, xxhdpi)
        run: |
          # 1. Elevate compile and target SDK to 34 (Android 14) dynamically across all modules
          find . -name "build.gradle" -exec sed -i 's/compileSdkVersion [0-9]*/compileSdkVersion 34/g' {} +
          find . -name "build.gradle" -exec sed -i 's/targetSdkVersion [0-9]*/targetSdkVersion 34/g' {} +
          
          # 2. Remove hardcoded buildToolsVersion so Android Gradle Plugin resolves the installed version natively
          find . -name "build.gradle" -exec sed -i '/buildToolsVersion/d' {} +

          # 3. Restrict native ABIs to arm64-v8a only (arm8) across ALL modules safely
          sed -i 's/"arm64-v8a", "x86_64"/"arm64-v8a"/g' app/build.gradle
          find . -name "build.gradle" -exec sed -i 's/"armeabi-v7a"/"arm64-v8a"/g' {} +

          # 4. Inject APK density splits for xxhdpi directly into the app module.
          cat <<EOF >> app/build.gradle

          android {
              splits {
                  density {
                      enable true
                      reset()
                      include "xxhdpi"
                      universalApk false
                  }
              }
          }
          EOF

      - name: üîê Generate Release Keystore & Configure Signing
        run: |
          keytool -genkey -v \
            -keystore release.jks \
            -keyalg RSA \
            -keysize 2048 \
            -validity 10000 \
            -alias virtualapp \
            -dname "CN=VirtualApp, OU=Dev, O=VirtualXposed, L=City, ST=State, C=US" \
            -storepass virtual123 \
            -keypass virtual123

          # Inject local.properties so Gradle automatically applies the Release Signing Config
          cat <<EOF > local.properties
          keystore.path=${GITHUB_WORKSPACE}/release.jks
          keystore.alias=virtualapp
          keystore.pwd=virtual123
          keystore.alias_pwd=virtual123
          EOF

      - name: üöÄ Build Final Release APK
        run: |
          chmod +x gradlew
          # Added --no-daemon. On ephemeral CI runners, the daemon serves no benefit
          # and actively risks corrupting the JVM memory pool. 
          ./gradlew assembleAospRelease \
            --no-daemon \
            --parallel \
            --max-workers=$(nproc)

      - name: üì¶ Locate, Verify & Rename APK
        run: |
          # Because we used a density split, the output name changes. 
          # We search recursively for the xxhdpi output.
          APK_PATH=$(find app/build/outputs/apk/aosp/release -name "*xxhdpi*.apk" | head -n 1)

          # Fallback if density split was ignored
          if [ -z "$APK_PATH" ]; then
            echo "‚ö†Ô∏è Split APK not found. Checking for universal fallback..."
            APK_PATH=$(find app/build/outputs/apk/aosp/release -name "*.apk" | head -n 1)
          fi

          if [ -z "$APK_PATH" ]; then
            echo "‚ùå CRITICAL ERROR: APK compilation failed or output not found."
            exit 1
          fi

          echo "‚úÖ Successfully selected APK: $APK_PATH"
          cp "$APK_PATH" VirtualApp-Android14-arm8-xxhdpi.apk

      - name: üì§ Upload Finished Artifact
        uses: actions/upload-artifact@v4
        with:
          name: VirtualApp-Android14-arm8-xxhdpi
          path: VirtualApp-Android14-arm8-xxhdpi.apk
          retention-days: 14
          if-no-files-found: error
