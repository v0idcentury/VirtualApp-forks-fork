name: Compile VirtualApp (Android 14 | arm8 | xxhdpi)

on:
  push:
    branches: [ "master", "main" ]
  pull_request:
    branches: [ "master", "main" ]
  workflow_dispatch:

jobs:
  build-apk:
    name: Build Highly-Optimized VirtualApp APK
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Source Code
        uses: actions/checkout@v4

      - name: Setup JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      # Caching is disabled to bypass transient GitHub "400 Bad Request" outages 
      - name: Setup Fast Gradle Environment
        uses: gradle/actions/setup-gradle@v3
        with:
          gradle-version: wrapper
          cache-disabled: true 

      - name: üõ†Ô∏è Surgical Codebase Patcher (Python)
        run: |
          # We use an isolated Python script to avoid all Bash/Regex quoting and nesting disasters
          cat << 'EOF' > patch.py
          import os, re

          # 1. Purge legacy JVM properties that crash Java 17 and AGP
          if os.path.exists("gradle.properties"):
              with open("gradle.properties", "r") as f: props = f.read()
              props = props.replace("android.useDeprecatedNdk=true", "")
              props = props.replace("MaxPermSize", "MaxMetaspaceSize")
              props = re.sub(r"org\.gradle\.jvmargs=.*", "org.gradle.jvmargs=-Xmx4096m -XX:MaxMetaspaceSize=1024m -XX:+HeapDumpOnOutOfMemoryError -Dfile.encoding=UTF-8", props)
              with open("gradle.properties", "w") as f: f.write(props)

          # 2. Iterate and patch every build.gradle file dynamically
          for root, dirs, files in os.walk("."):
              for file in files:
                  if file == "build.gradle":
                      filepath = os.path.join(root, file)
                      with open(filepath, "r") as f: content = f.read()
                      
                      # Elevate SDK APIs and drop hardcoded tools to let AGP auto-resolve safely
                      content = re.sub(r"compileSdkVersion\s+\d+", "compileSdkVersion 34", content)
                      content = re.sub(r"targetSdkVersion\s+\d+", "targetSdkVersion 34", content)
                      content = re.sub(r"buildToolsVersion\s+[\x27\x22].*?[\x27\x22]", "", content)
                      
                      # Safely restrict ABI to arm64-v8a arrays
                      content = content.replace('["armeabi-v7a"]', '["arm64-v8a"]')
                      content = content.replace('"arm64-v8a", "x86_64"', '"arm64-v8a"')
                      
                      if "app/build.gradle" in filepath.replace(os.sep, "/"):
                          # SURGICAL FIX A: Eradicate the nested 'android' block that crashes AGP 7+
                          bad_ndk_block = r"android\s*\{\s*defaultConfig\s*\{\s*ndk\s*\{\s*abiFilters[^}]+\}\s*\}\s*\}"
                          content = re.sub(bad_ndk_block, "ndk { abiFilters \"arm64-v8a\" }", content)
                          
                          # SURGICAL FIX B: Delete the deprecated manifestFile closure without leaving dangling braces
                          bad_manifest_block = r"applicationVariants\.all\s*\{.*?manifestFile\.write\(manifestContent\)\s*\}\s*\}\s*\}"
                          content = re.sub(bad_manifest_block, "", content, flags=re.DOTALL)
                      
                      with open(filepath, "w") as f: f.write(content)

          # 3. Append the strict xxhdpi density splits
          with open("app/build.gradle", "a") as f:
              f.write("\nandroid {\n  splits {\n    density {\n      enable true\n      reset()\n      include \"xxhdpi\"\n      universalApk false\n    }\n  }\n}\n")
          EOF
          
          python patch.py
          rm patch.py

      - name: üîê Generate Native Release Keystore
        run: |
          keytool -genkey -v \
            -keystore release.jks \
            -keyalg RSA \
            -keysize 2048 \
            -validity 10000 \
            -alias virtualapp \
            -dname "CN=VirtualApp, OU=Dev, O=VirtualXposed, L=City, ST=State, C=US" \
            -storepass virtual123 \
            -keypass virtual123

          # Instruct Gradle to sign the resulting APK using the generated key above
          cat <<EOF > local.properties
          keystore.path=${GITHUB_WORKSPACE}/release.jks
          keystore.alias=virtualapp
          keystore.pwd=virtual123
          keystore.alias_pwd=virtual123
          EOF

      - name: üöÄ Assemble Release APK
        run: |
          chmod +x gradlew
          # `--no-daemon` prevents OOM memory locks on CI runners.
          ./gradlew assembleAospRelease --no-daemon --parallel --max-workers=$(nproc)

      - name: üì¶ Locate, Verify & Normalize APK Output
        run: |
          echo "Hunting for xxhdpi split..."
          APK_PATH=$(find app/build/outputs/apk -type f -name "*xxhdpi*.apk" | head -n 1)

          if [ -z "$APK_PATH" ]; then
            echo "‚ö†Ô∏è xxhdpi split not found. Grabbing Universal APK instead..."
            APK_PATH=$(find app/build/outputs/apk -type f -name "*.apk" | head -n 1)
          fi

          if [ -z "$APK_PATH" ]; then
            echo "‚ùå FATAL: APK build failed or output dir is entirely empty."
            exit 1
          fi

          echo "‚úÖ Built Successfully! Wrapping artifact from path: $APK_PATH"
          cp "$APK_PATH" VirtualApp-Android14-arm8-xxhdpi.apk

      - name: üì§ Upload Finished APK
        uses: actions/upload-artifact@v4
        with:
          name: VirtualApp-Android14-arm8-xxhdpi
          path: VirtualApp-Android14-arm8-xxhdpi.apk
          retention-days: 14
          if-no-files-found: error
