name: Compile VirtualApp (Android 14 | arm8 | xxhdpi)

on:
  push:
    branches: [ "master", "main" ]
  pull_request:
    branches: [ "master", "main" ]
  workflow_dispatch:

jobs:
  build-apk:
    name: Build Highly-Optimized VirtualApp APK
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Source Code
        uses: actions/checkout@v4

      - name: Setup JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      # Caching is disabled intentionally to bypass the persistent 
      # "Cache service responded with 400" outages seen in the logs.
      - name: Setup Fast Gradle Environment
        uses: gradle/actions/setup-gradle@v3
        with:
          gradle-version: wrapper
          cache-disabled: true 

      - name: üßπ Deep Sanitize Gradle Properties (CRITICAL FIX)
        run: |
          # 1. ERADICATE the deprecated NDK flag causing the plugin to crash
          sed -i '/android.useDeprecatedNdk/d' gradle.properties
          
          # 2. Fix Java 17 Metaspace crashes by purging MaxPermSize
          sed -i 's/MaxPermSize/MaxMetaspaceSize/g' gradle.properties
          
          # 3. Ensure JVM limits are safely clamped to avoid ephemeral runner OOM
          sed -i 's/org.gradle.jvmargs=.*/org.gradle.jvmargs=-Xmx4096m -XX:MaxMetaspaceSize=1024m -XX:+HeapDumpOnOutOfMemoryError -Dfile.encoding=UTF-8/g' gradle.properties

      - name: üß¨ Patch Codebase (Android 14, arm8, xxhdpi)
        run: |
          # Elevate compile & target SDK to 34 (Android 14) dynamically
          find . -name "build.gradle" -exec sed -i 's/compileSdkVersion [0-9]*/compileSdkVersion 34/g' {} +
          find . -name "build.gradle" -exec sed -i 's/targetSdkVersion [0-9]*/targetSdkVersion 34/g' {} +
          
          # Remove hardcoded buildToolsVersion so Android SDK auto-resolves the proper toolchain
          find . -name "build.gradle" -exec sed -i '/buildToolsVersion/d' {} +

          # Surgically restrict ABI to arm64-v8a handling both string & array syntax natively
          sed -i 's/"arm64-v8a", "x86_64"/"arm64-v8a"/g' app/build.gradle
          find . -name "build.gradle" -exec sed -i 's/\["armeabi-v7a"\]/\["arm64-v8a"\]/g' {} +

          # Safely append the xxhdpi density splits into the App module
          cat <<EOF >> app/build.gradle

          android {
              splits {
                  density {
                      enable true
                      reset()
                      include "xxhdpi"
                      universalApk false
                  }
              }
          }
          EOF

      - name: üîê Generate Native Release Keystore
        run: |
          keytool -genkey -v \
            -keystore release.jks \
            -keyalg RSA \
            -keysize 2048 \
            -validity 10000 \
            -alias virtualapp \
            -dname "CN=VirtualApp, OU=Dev, O=VirtualXposed, L=City, ST=State, C=US" \
            -storepass virtual123 \
            -keypass virtual123

          # Instruct Gradle to sign the resulting APK using the generated key above
          cat <<EOF > local.properties
          keystore.path=${GITHUB_WORKSPACE}/release.jks
          keystore.alias=virtualapp
          keystore.pwd=virtual123
          keystore.alias_pwd=virtual123
          EOF

      - name: üöÄ Assemble Release APK
        run: |
          chmod +x gradlew
          # `--no-daemon` prevents OOM memory locks on CI runners.
          # Building 'assembleAospRelease' utilizes the accurate app-signing dimension.
          ./gradlew assembleAospRelease --no-daemon --parallel --max-workers=$(nproc)

      - name: üì¶ Locate, Verify & Normalize APK Output
        run: |
          echo "Hunting for xxhdpi split..."
          APK_PATH=$(find app/build/outputs/apk -type f -name "*xxhdpi*.apk" | head -n 1)

          # Fallback handler if splits get ignored inside the project context
          if [ -z "$APK_PATH" ]; then
            echo "‚ö†Ô∏è xxhdpi split not found. Grabbing Universal APK instead..."
            APK_PATH=$(find app/build/outputs/apk -type f -name "*.apk" | head -n 1)
          fi

          if [ -z "$APK_PATH" ]; then
            echo "‚ùå FATAL: APK build failed or output dir is entirely empty."
            exit 1
          fi

          echo "‚úÖ Built Successfully! Wrapping artifact from path: $APK_PATH"
          cp "$APK_PATH" VirtualApp-Android14-arm8-xxhdpi.apk

      - name: üì§ Upload Finished APK
        uses: actions/upload-artifact@v4
        with:
          name: VirtualApp-Android14-arm8-xxhdpi
          path: VirtualApp-Android14-arm8-xxhdpi.apk
          retention-days: 14
          if-no-files-found: error
